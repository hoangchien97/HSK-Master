generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  // SEO Fields
  metaTitle        String?
  metaDescription  String?

  courses     Course[]
}

model Course {
  id               String         @id @default(uuid())
  title            String
  slug             String         @unique
  description      String?
  image            String?
  instructor       String?
  instructorAvatar String?
  level            String?
  tag              String?
  badgeText        String?
  badgeColor       String?
  vocabularyCount  Int            @default(0)
  grammarCount     Int            @default(0)
  lessonCount      Int            @default(0)
  durationHours    Int            @default(0)
  lectures         Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now()) @updatedAt
  publishedAt      DateTime?
  categoryId       String
  hskLevelId       String?
  isPublished      Boolean        @default(true)
  isFeatured       Boolean        @default(false)

  // SEO Fields
  metaTitle        String?        // Custom SEO title (max 60 chars)
  metaDescription  String?        // Custom SEO description (max 160 chars)
  keywords         String?        // Comma-separated keywords
  ogImage          String?        // Open Graph image URL
  canonicalUrl     String?        // Canonical URL for duplicate content

  // Analytics & Social Proof
  viewCount        Int            @default(0)
  enrollmentCount  Int            @default(0)

  // Video & Rich Media
  videoUrl         String?        // Course intro video URL
  videoThumbnail   String?        // Video thumbnail

  category         Category       @relation(fields: [categoryId], references: [id])
  hskLevel         HSKLevel?      @relation(fields: [hskLevelId], references: [id])
  lessons          Lesson[]
  grammarPoints    GrammarPoint[]
  registrations    Registration[]
}

model Lesson {
  id           String       @id @default(uuid())
  courseId     String
  title        String
  titleChinese String?
  description  String?
  order        Int
  isLocked     Boolean      @default(false)
  progress     Int          @default(0)
  createdAt    DateTime     @default(now())
  course       Course       @relation(fields: [courseId], references: [id])
  vocabularies Vocabulary[]
}

model Vocabulary {
  id        String   @id @default(uuid())
  lessonId  String
  word      String
  pinyin    String?
  meaning   String
  audioUrl  String?
  createdAt DateTime @default(now())
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
}

model Registration {
  id        String   @id @default(uuid())
  name      String
  phone     String
  email     String?
  note      String?
  createdAt DateTime @default(now())
  courseId  String?
  course    Course?  @relation(fields: [courseId], references: [id])
}

// Hero Slideshow
model HeroSlide {
  id               String   @id @default(uuid())
  image            String
  badge            String
  badgeColor       String
  title            String
  description      String
  primaryCtaText   String
  primaryCtaHref   String
  secondaryCtaText String?
  secondaryCtaHref String?
  overlayGradient  String
  order            Int
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// HSK Levels
model HSKLevel {
  id              String   @id @default(uuid())
  level           Int      @unique
  title           String
  badge           String
  badgeColor      String
  description     String
  vocabularyCount String
  targetAudience  String
  targetIcon      String
  accentColor     String
  bgGradient      String
  href            String
  order           Int
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // SEO Fields
  metaTitle        String?
  metaDescription  String?
  keywords         String?

  courses         Course[]
}

// Why Choose Us Features
model Feature {
  id          String   @id @default(uuid())
  iconName    String   // Lucide icon name (e.g., "GraduationCap", "BookOpen")
  title       String
  description String
  order       Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// CTA Section Stats
model CtaStat {
  id          String   @id @default(uuid())
  value       Int
  suffix      String?
  label       String
  order       Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Photo Albums
model Album {
  id          String   @id @default(uuid())
  title       String
  description String?
  thumbnail   String
  photoCount  Int      @default(0)
  order       Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  photos      Photo[]
}

model Photo {
  id          String   @id @default(uuid())
  albumId     String
  url         String
  title       String?
  description String?
  order       Int
  createdAt   DateTime @default(now())
  album       Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
}

// Grammar Points for Courses
model GrammarPoint {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  titleChinese String?
  description String?
  order       Int
  createdAt   DateTime @default(now())
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

// Student Reviews
model Review {
  id          String   @id @default(uuid())
  studentName String
  className   String   // HSK 1, HSK 2, etc.
  content     String
  rating      Int      // 1-5 stars
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Page Metadata for SEO Management
model PageMetadata {
  id               String   @id @default(uuid())
  pagePath         String   @unique // e.g., "/", "/about", "/contact", "/courses"
  pageName         String   // Friendly name for admin
  title            String   // SEO title (max 60 chars)
  description      String   // Meta description (max 160 chars)
  keywords         String?  // Comma-separated keywords

  // Open Graph
  ogTitle          String?
  ogDescription    String?
  ogImage          String?
  ogType           String?  @default("website")

  // Twitter Card
  twitterCard      String?  @default("summary_large_image")
  twitterTitle     String?
  twitterDescription String?
  twitterImage     String?

  // Additional SEO
  canonicalUrl     String?
  robots           String?  @default("index, follow")

  // Status
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([pagePath])
}

// ============================================
// PORTAL MODELS (Admin & Learning Management)
// ============================================

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String      @id @default(cuid())
  sessionToken String      @unique @map("session_token")
  userId       String      @map("user_id")
  expires      DateTime
  user         PortalUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Role and Status enums
enum UserRole {
  SYSTEM_ADMIN
  TEACHER
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
}

// Portal User (Unified user model with all profile fields)
model PortalUser {
  id            String     @id @default(cuid())
  name          String     // Display name (e.g., "Hoang Chien") - same as Google profile name
  username      String     @unique // Unique slug for profile URL (e.g., /portal/profile/hoangchien)
  email         String     @unique
  emailVerified DateTime?  @map("email_verified")
  password      String?    // For email/password auth (hashed with bcrypt)
  image         String?
  role          UserRole   @default(STUDENT)
  status        UserStatus @default(ACTIVE)

  // Profile fields
  phoneNumber   String?
  address       String?
  dateOfBirth   DateTime?
  biography     String?    @db.Text // Giới thiệu bản thân (cho cả teacher và student)

  notes         String?    @db.Text // Admin notes
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]

  // Student relations (when role=STUDENT)
  enrollments      PortalClassEnrollment[]
  studentAttendances PortalAttendance[] @relation("StudentAttendance")
  submissions      PortalAssignmentSubmission[]
  progress         PortalLearningProgress[]
  vocabularies     PortalVocabulary[]
  bookmarks        PortalBookmark[]
  quizAttempts     PortalQuizAttempt[]

  // Teacher relations (when role=TEACHER or SYSTEM_ADMIN)
  classes          PortalClass[]
  schedules        PortalSchedule[]
  assignments      PortalAssignment[]
  teacherAttendances PortalAttendance[] @relation("TeacherAttendance")

  @@map("portal_users")
}

// Portal Class (Teacher's classes)
model PortalClass {
  id               String   @id @default(cuid())
  className        String   // e.g., "HSK 1 - Sáng Thứ 2, 4, 6"
  classCode        String   @unique // e.g., "HSK1-MWF-AM-2025"
  description      String?  @db.Text
  teacherId        String
  level            String?  // HSK level
  startDate        DateTime
  endDate          DateTime?
  status           String   @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  teacher          PortalUser                @relation(fields: [teacherId], references: [id])
  enrollments      PortalClassEnrollment[]
  schedules        PortalSchedule[]
  assignments      PortalAssignment[]
  attendances      PortalAttendance[]

  @@map("portal_classes")
}

// Portal Class Enrollment (Student enrollments in classes)
model PortalClassEnrollment {
  id               String   @id @default(cuid())
  studentId        String
  classId          String
  enrolledAt       DateTime @default(now())
  status           String   @default("ENROLLED") // ENROLLED, COMPLETED, DROPPED
  finalGrade       Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  student          PortalUser @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class            PortalClass   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@map("portal_class_enrollments")
}

// Portal Schedule (Class schedule/calendar)
model PortalSchedule {
  id               String   @id @default(cuid())
  classId          String
  teacherId        String
  title            String   // e.g., "Bài 5: Ngữ pháp"
  description      String?  @db.Text
  startTime        DateTime
  endTime          DateTime
  location         String?  // e.g., "Phòng 301" or "Google Meet"
  meetingLink      String?  // Online meeting link
  status           String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED

  // Recurrence group — all schedules created from the same recurring rule share this ID
  recurrenceGroupId String?

  // Google Calendar Sync
  googleEventId    String?  // Google Calendar event ID for synced events
  syncedToGoogle   Boolean  @default(false) // Whether this event is synced to Google Calendar

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  class            PortalClass   @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher          PortalUser @relation(fields: [teacherId], references: [id])

  @@map("portal_schedules")
}

// Portal Attendance (Student attendance tracking)
model PortalAttendance {
  id               String   @id @default(cuid())
  studentId        String
  classId          String
  teacherId        String
  date             DateTime @default(now())
  status           String   // PRESENT, ABSENT, LATE, EXCUSED
  notes            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  student          PortalUser @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)
  class            PortalClass   @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher          PortalUser @relation("TeacherAttendance", fields: [teacherId], references: [id])

  @@unique([studentId, classId, date])
  @@map("portal_attendances")
}

// Portal Assignment (Teacher assignments)
model PortalAssignment {
  id               String   @id @default(cuid())
  classId          String
  teacherId        String
  title            String
  description      String?  @db.Text
  assignmentType   String   // HOMEWORK, QUIZ, PROJECT, READING, WRITING, SPEAKING, LISTENING
  dueDate          DateTime?
  maxScore         Float    @default(100)
  attachments      String[] // Array of file URLs
  status           String   @default("ACTIVE") // ACTIVE, DRAFT, ARCHIVED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  class            PortalClass                @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher          PortalUser              @relation(fields: [teacherId], references: [id])
  submissions      PortalAssignmentSubmission[]

  @@map("portal_assignments")
}

// Portal Assignment Submission
model PortalAssignmentSubmission {
  id               String   @id @default(cuid())
  assignmentId     String
  studentId        String
  content          String?  @db.Text
  attachments      String[] // Array of file URLs
  submittedAt      DateTime @default(now())
  score            Float?
  feedback         String?  @db.Text
  status           String   @default("SUBMITTED") // SUBMITTED, GRADED, LATE
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  assignment       PortalAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student          PortalUser    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@map("portal_assignment_submissions")
}

// Portal Learning Progress (Track student progress in skills)
model PortalLearningProgress {
  id               String   @id @default(cuid())
  studentId        String
  skillType        String   // LISTENING, SPEAKING, READING, WRITING
  level            String   // HSK1, HSK2, etc.
  lessonId         String?  // Reference to Course Lesson
  completedAt      DateTime?
  score            Float?
  timeSpent        Int?     // in minutes
  notes            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  student          PortalUser @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("portal_learning_progress")
}

// Portal Vocabulary (Student's vocabulary learning)
model PortalVocabulary {
  id               String   @id @default(cuid())
  studentId        String
  word             String
  pinyin           String?
  meaning          String
  example          String?  @db.Text
  level            String?  // HSK level
  mastery          String   @default("NEW") // NEW, LEARNING, MASTERED
  reviewCount      Int      @default(0)
  lastReviewedAt   DateTime?
  nextReviewAt     DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  student          PortalUser @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("portal_vocabularies")
}

// Portal Bookmark (Student bookmarks for lessons/vocabulary)
model PortalBookmark {
  id               String   @id @default(cuid())
  studentId        String
  resourceType     String   // LESSON, VOCABULARY, GRAMMAR, COURSE
  resourceId       String   // ID of the bookmarked resource
  notes            String?  @db.Text
  createdAt        DateTime @default(now())

  student          PortalUser @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, resourceType, resourceId])
  @@map("portal_bookmarks")
}

// Portal Quiz
model PortalQuiz {
  id               String   @id @default(cuid())
  title            String
  description      String?  @db.Text
  level            String?  // HSK level
  questionCount    Int
  timeLimit        Int?     // in minutes
  passingScore     Float    @default(70)
  quizType         String   // VOCABULARY, GRAMMAR, LISTENING, READING, COMPREHENSIVE
  questions        Json     // Store quiz questions as JSON
  status           String   @default("ACTIVE") // ACTIVE, DRAFT, ARCHIVED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  attempts         PortalQuizAttempt[]

  @@map("portal_quizzes")
}

// Portal Quiz Attempt
model PortalQuizAttempt {
  id               String   @id @default(cuid())
  quizId           String
  studentId        String
  answers          Json     // Store student answers as JSON
  score            Float
  correctCount     Int
  incorrectCount   Int
  timeSpent        Int?     // in minutes
  completedAt      DateTime @default(now())
  passed           Boolean  @default(false)

  quiz             PortalQuiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student          PortalUser @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("portal_quiz_attempts")
}
